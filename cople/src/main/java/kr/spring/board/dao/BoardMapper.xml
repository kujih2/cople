<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.board.dao.BoardMapper">
	<!-- 게시글 글 등록 -->
	<insert id="insertBoard" parameterType="boardVO">
		INSERT INTO
		commu_board(board_num,title,content,ip,mem_num)
		VALUES (commu_board_seq.nextval, #{title}, #{content}, #{ip}, #{mem_num})
	</insert>
	
	<!-- sql 태그와 include 태그를 이용해 SQL문 재사용 -->
	<sql id="boardSearch">
		<where>
			<if test="keyword != null and keyword != ''">
				title LIKE '%' || #{keyword} || '%' OR
				content LIKE '%' || #{keyword} || '%'
			</if>
		</where>
	</sql>
	
	<sql id="boardOrder">
		<if test="order == 1">
			ORDER BY board_num DESC
		</if>
		<if test="order == 2">
			ORDER BY hit DESC
		</if>
		<if test="order == 3">
			ORDER BY favhate_cnt DESC NULLS LAST
		</if>
		<if test="order == 4">
			ORDER BY re_cnt DESC NULLS LAST
		</if>
	</sql>
	
	<!-- 게시판 글 총개수/검색 개수 -->
	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT COUNT(*) FROM commu_board JOIN member USING(mem_num)
		<include refid="boardSearch"></include>
	</select>
	
	<!-- 게시판 전체 목록/검색 목록 -->
	<select id="selectList" parameterType="map" resultType="boardVO">
		SELECT
		   *
		FROM (SELECT
		        a.*,
		        rownum rnum
		      FROM (SELECT
		               board_num,
		               <![CDATA[
		               REPLACE(REPLACE(title,'<','&lt;'),'>','&gt;') title,
		               ]]>
		               hit,
		               reg_date,
		               mem_num,
		               id,
		               nick_name
		            FROM commu_board JOIN member USING(mem_num) 
		            <include refid="boardSearch"></include>
		            <include refid="boardOrder"></include>)a)
		<![CDATA[
		WHERE rnum >= #{start} AND rnum <= #{end}
		]]>            
	</select>
	
	<!-- 글 상세 -->
	<select id="detailBoard" parameterType="integer">
		SELECT * FROM commu_board JOIN member USING(mem_num) 
		LEFT OUTER JOIN member_detail USING(mem_num) 
		WHERE board_num=#{board_num}
	</select>
	
	<!-- 글 수정 -->
	<update id="updateBoard" parameterType="boardVO">
		UPDATE commu_board SET 
		  title=#{title},
		  content=#{content}, 
		  ip=#{ip},
		  modify_date=SYSDATE 
		WHERE board_num=#{board_num}
	</update>
</mapper>
